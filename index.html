<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crispy Chicken - Advanced Analytics</title>
    <style>
        :root {
            --primary: #e65100; 
            --primary-dark: #ac3b00;
            --secondary: #263238; 
            --bg-light: #f5f6fa;
            --white: #ffffff;
            --border: #dcdde1;
            --text-main: #2f3640;
            --text-light: #7f8fa6;
            --success: #2ecc71;
            --aggregator-color: #e8f5e9; /* Light Green background for Aggregators */
            --shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        * { box-sizing: border-box; outline: none; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-light);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        aside {
            width: 280px; 
            background-color: var(--secondary);
            color: var(--white);
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(255,255,255,0.1);
            flex-shrink: 0;
        }

        .brand {
            padding: 20px;
            background: linear-gradient(135deg, #ff9800, #e65100);
            font-weight: bold;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .branch-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .branch-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.85rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: block; 
            white-space: normal;
            line-height: 1.3;
        }

        .branch-item:hover { background-color: rgba(255,255,255,0.05); }
        .branch-item.active { 
            background-color: var(--primary); 
            font-weight: 600; 
            padding-left: 25px; 
        }

        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            background: var(--white);
            padding: 15px 30px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h2 { margin: 0; font-size: 1.4rem; color: var(--secondary); }

        .controls { display: flex; gap: 10px; align-items: center; }
        
        select, button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            background: white;
            cursor: pointer;
        }

        button.primary-btn {
            background: var(--primary);
            color: white;
            border: none;
            font-weight: 500;
            transition: 0.2s;
        }
        button.primary-btn:hover { background: var(--primary-dark); }

        .filter-group {
            background: #f1f2f6;
            padding: 5px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .tabs {
            display: flex;
            background: var(--white);
            border-bottom: 1px solid var(--border);
        }
        .tab-btn {
            padding: 15px 25px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-light);
            border-bottom: 3px solid transparent;
        }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

        .view-container { flex: 1; overflow: hidden; position: relative; }
        .view { display: none; height: 100%; overflow-y: auto; padding: 20px; animation: fadeIn 0.3s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .table-wrapper { background: var(--white); border-radius: 8px; box-shadow: var(--shadow); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; min-width: 600px; }
        th, td { padding: 10px; border-bottom: 1px solid var(--border); text-align: center; }
        th { background-color: #f8f9fa; font-weight: 600; color: var(--secondary); position: sticky; top: 0; z-index: 10; text-align: center;}
        
        /* Channel Headers Styling */
        .channel-header { background-color: #fff3e0; color: var(--primary-dark); text-align: center; padding: 8px; font-size: 0.7rem; text-transform: uppercase; border-bottom: 1px solid #ffe0b2; }
        
        .channel-header.aggregator {
            background-color: var(--aggregator-color);
            color: #1b5e20;
            border-bottom: 1px solid #c8e6c9;
        }
        
        .separator-line {
            border-right: 2px solid var(--primary-dark);
        }

        .sub-header { 
            background-color: #fff8e1; 
            font-size: 0.75rem; 
            width: 90px; 
            line-height: 1.3;
            vertical-align: middle;
        }
        .sub-header.aggregator-bg {
            background-color: #f1f8e9;
        }

        .sub-header small {
            display: block;
            font-weight: normal;
            font-size: 0.65rem;
            color: #795548;
        }

        input[type="number"] { 
            width: 70px; 
            padding: 5px; 
            border: 1px solid var(--border); 
            border-radius: 4px; 
            text-align: right; 
            font-size: 0.85rem; 
        }
        input[type="number"]:focus { border-color: var(--primary); background-color: #fff3e0; }
        
        .row-total { 
            font-weight: bold; 
            color: var(--primary-dark); 
            background-color: #fff8e1; 
            border-left: 2px solid var(--primary); 
        }
        
        .total-row-footer { background-color: #eceff1; font-weight: bold; color: var(--primary-dark); border-top: 2px solid var(--border); }

        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .kpi-card { background: var(--white); padding: 20px; border-radius: 8px; box-shadow: var(--shadow); border-left: 4px solid var(--primary); }
        .kpi-title { font-size: 0.8rem; color: var(--text-light); margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
        .kpi-value { font-size: 1.5rem; font-weight: bold; color: var(--secondary); }

        .chart-container { background: var(--white); padding: 20px; border-radius: 8px; box-shadow: var(--shadow); margin-bottom: 20px; height: 350px; position: relative; }
        svg.chart { width: 100%; height: 100%; overflow: visible; }
        .chart-line { fill: none; stroke: var(--primary); stroke-width: 2; }
        .chart-bar { fill: var(--primary); opacity: 0.7; transition: opacity 0.2s; }
        .chart-bar:hover { opacity: 1; }
        .chart-axis text { font-size: 10px; fill: #999; }
        .chart-grid line { stroke: #eee; stroke-width: 1; }
        .legend { display: flex; gap: 15px; justify-content: center; margin-bottom: 15px; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 5px; font-size: 0.85rem; }
        .color-box { width: 12px; height: 12px; border-radius: 2px; }

        .toast { position: fixed; bottom: 20px; right: 20px; background: var(--secondary); color: white; padding: 10px 20px; border-radius: 4px; opacity: 0; transform: translateY(20px); transition: 0.3s; pointer-events: none; }
        .toast.show { opacity: 1; transform: translateY(0); }

        .alert-box { padding: 10px; background: #e3f2fd; color: #0d47a1; border: 1px solid #bbdefb; border-radius: 4px; margin-bottom: 20px; font-size: 0.9rem; }
        .alert-success { background: #d4edda; color: #155724; border-color: #c3e6cb; }
        .alert-warning { background: #fff3cd; color: #856404; border-color: #ffeeba; }

    </style>
</head>
<body>

    <aside>
        <div class="brand">üçó Crispy Chicken</div>
        <div class="branch-list" id="branchList"></div>
        <div style="padding: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
            <button onclick="exportData()" style="width:100%; padding:10px; background:rgba(255,255,255,0.1); color:white; border:none; border-radius:4px; cursor:pointer;">Download Backup</button>
        </div>
    </aside>

    <main>
        <header>
            <div>
                <h2 id="pageTitle">Dashboard</h2>
                <div id="subTitle" style="font-size:0.8rem; color:#888; margin-top:2px;">Select a branch to view data</div>
            </div>
            
            <div class="controls">
                <div class="filter-group">
                    <span style="font-size:0.8rem; color:#666;">Scope:</span>
                    <select id="scopeSelector" onchange="handleScopeChange()">
                        <option value="month">Current Month</option>
                        <option value="q1">Q1 (Jan-Mar)</option>
                        <option value="q2">Q2 (Apr-Jun)</option>
                        <option value="q3">Q3 (Jul-Sep)</option>
                        <option value="q4">Q4 (Oct-Dec)</option>
                        <option value="year">Full Year 2026</option>
                    </select>
                </div>

                <div id="monthSelectorContainer">
                    <select id="monthSelector" onchange="handleMonthChange()">
                        <option value="2026-01">January 2026</option>
                        <option value="2026-02">February 2026</option>
                        <option value="2026-03">March 2026</option>
                        <option value="2026-04">April 2026</option>
                        <option value="2026-05">May 2026</option>
                        <option value="2026-06">June 2026</option>
                        <option value="2026-07">July 2026</option>
                        <option value="2026-08">August 2026</option>
                        <option value="2026-09">September 2026</option>
                        <option value="2026-10">October 2026</option>
                        <option value="2026-11">November 2026</option>
                        <option value="2026-12">December 2026</option>
                    </select>
                </div>
                
                <button class="primary-btn" onclick="resetCurrentData()">Clear Data</button>
            </div>
        </header>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('entry')">Data Entry</button>
            <button class="tab-btn" onclick="switchTab('analysis')">Branch Analysis</button>
            <button class="tab-btn" onclick="switchTab('company')">Company Report</button>
        </div>

        <div class="view-container">
            
            <!-- VIEW 1: Data Entry -->
            <div id="view-entry" class="view active">
                <div class="alert-box alert-warning">
                    ‚ö†Ô∏è <strong>Note:</strong> "Delivery" (In-house) is separate from Aggregators (Keeta, Noon, etc.).<br>
                    TRN should generally be whole numbers, but decimals are accepted for system data.
                </div>
                <div class="table-wrapper">
                    <table id="salesTable" style="min-width: 1750px;">
                        <thead><tr id="tableHeader"></tr></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- VIEW 2: Branch Analysis -->
            <div id="view-analysis" class="view">
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-title">Total Sales</div>
                        <div class="kpi-value" id="kpiTotalSales">0.00</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">Total TRN</div>
                        <div class="kpi-value" id="kpiTotalTrn">0</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">Overall Avg Check</div>
                        <div class="kpi-value" id="kpiAvgChk">0.00</div>
                    </div>
                    <div class="kpi-card" style="border-left-color: #8e44ad;">
                        <div class="kpi-title">Company Share %</div>
                        <div class="kpi-value" id="kpiCompanyShare">0.0%</div>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>Sales Trend</h3>
                    <svg id="salesChart" class="chart" viewBox="0 0 800 300" preserveAspectRatio="none"></svg>
                </div>

                <!-- NEW: Avg Check Comparison Chart -->
                <div class="chart-container" style="border-left: 4px solid #2ecc71;">
                    <h3>Avg Check Comparison (Value per Order)</h3>
                    <svg id="avgCheckChart" class="chart" viewBox="0 0 800 300"></svg>
                </div>

                <!-- Channel Breakdown Sales -->
                <div class="chart-container">
                    <h3>Channel Breakdown (Sales)</h3>
                    <div class="legend" id="channelLegend"></div>
                    <svg id="channelChart" class="chart" viewBox="0 0 800 300"></svg>
                </div>

                <!-- Detailed Channel Table -->
                <div class="table-wrapper">
                    <h3 style="padding: 15px 15px 0 15px; margin:0; color:var(--primary-dark);">Channel Performance Details</h3>
                    <table style="min-width: 800px;">
                        <thead>
                            <tr>
                                <th>Channel Name</th>
                                <th>Total Sales</th>
                                <th>Total TRN</th>
                                <th>Avg Check</th>
                                <th>% Contribution</th>
                            </tr>
                        </thead>
                        <tbody id="channelDetailBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- VIEW 3: Company Report -->
            <div id="view-company" class="view">
                <div class="kpi-grid">
                    <div class="kpi-card" style="border-left-color: #2980b9;">
                        <div class="kpi-title">Company Total</div>
                        <div class="kpi-value" id="compTotalSales">0.00</div>
                    </div>
                    <div class="kpi-card" style="border-left-color: #27ae60;">
                        <div class="kpi-title">Active Branches</div>
                        <div class="kpi-value" id="compActiveBranches">0</div>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table style="min-width: 800px;">
                        <thead>
                            <tr>
                                <th style="text-align:left; padding-left:20px;">Branch Name</th>
                                <th>Total Sales</th>
                                <th>Total TRN</th>
                                <th>Avg Check</th>
                                <th>% Share</th>
                                <th>Visual</th>
                            </tr>
                        </thead>
                        <tbody id="companyTableBody"></tbody>
                        <tfoot id="companyTableFooter" class="total-row-footer">
                            <!-- Total Row -->
                        </tfoot>
                    </table>
                </div>
            </div>

        </div>
    </main>

    <div id="toast" class="toast">Data Saved</div>

    <script>
        // --- Configuration ---
        const branches = [
            "Crispy Chicken Hamdan St",
            "Crispy Chicken Khaldia",
            "Crispy Chicken Shabiya 11",
            "Crispy Chicken Muroor",
            "Crispy Chicken Al Electra",
            "Crispy Chicken Al Barsha",
            "Crispy Chicken Al Satwa",
            "Crispy Chicken Al Rigga",
            "Crispy Chicken Al Majaz"
        ];

        const channels = [
            { id: 'dine_in', label: 'Dine in / Take out', type: 'in-house' },
            { id: 'delivery', label: 'Delivery', type: 'in-house' }, // In-house
            { id: 'online', label: 'Online', type: 'aggregator' }, 
            { id: 'keeta', label: 'Keeta', type: 'aggregator' },
            { id: 'noon', label: 'NOON', type: 'aggregator' },
            { id: 'smiles', label: 'SMILES', type: 'aggregator' },
            { id: 'careem', label: 'Careem', type: 'aggregator' },
            { id: 'delivero', label: 'DELIVERO', type: 'aggregator' }
        ];

        // State
        let currentBranchIndex = 0;
        let currentMonth = "2026-01"; 
        let currentScope = "month"; 
        let db = {}; 

        // --- Date Logic ---
        function getDaysInMonth(year, month) { return new Date(year, month + 1, 0).getDate(); }
        
        function getDateRangeByScope(scope, baseMonthStr) {
            const [year, month] = baseMonthStr.split('-').map(Number);
            let start = new Date(2026, 0, 1);
            let end = new Date(2026, 11, 31);

            switch(scope) {
                case 'month':
                    start = new Date(year, month - 1, 1);
                    end = new Date(year, month, 0);
                    break;
                case 'q1': start = new Date(2026, 0, 1); end = new Date(2026, 2, 31); break;
                case 'q2': start = new Date(2026, 3, 1); end = new Date(2026, 5, 30); break;
                case 'q3': start = new Date(2026, 6, 1); end = new Date(2026, 8, 30); break;
                case 'q4': start = new Date(2026, 9, 1); end = new Date(2026, 11, 31); break;
                case 'year': 
                    start = new Date(2026, 0, 1); 
                    end = new Date(2026, 11, 31); 
                    break;
            }
            return { start, end };
        }

        // --- Initialization ---
        window.addEventListener('DOMContentLoaded', () => {
            loadData();
            renderBranchList();
            renderTableStructure(); 
            loadFormData();
            setupAutoSave();
        });

        // --- Data Management ---
        function loadData() {
            const saved = localStorage.getItem('crispy_chicken_db_v5');
            if (saved) db = JSON.parse(saved);
            else branches.forEach(b => db[b] = {});
        }

        function saveData() {
            localStorage.setItem('crispy_chicken_db_v5', JSON.stringify(db));
            showToast();
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
            const a = document.createElement('a');
            a.href = dataStr;
            a.download = `crispy_chicken_report_${currentScope}.json`;
            document.body.appendChild(a);
            a.click();
            a.remove();
        }

        // --- Event Handlers ---
        function handleMonthChange() {
            currentMonth = document.getElementById('monthSelector').value;
            const activeTab = document.querySelector('.tab-btn.active').innerText;
            if (activeTab.includes('Entry')) loadFormData();
            else if (currentScope === 'month') {
                updateAnalysis(); 
                updateCompanyReport();
            }
            updateHeaderSubtitle();
        }

        function handleScopeChange() {
            currentScope = document.getElementById('scopeSelector').value;
            updateHeaderSubtitle();
            if (document.getElementById('view-analysis').classList.contains('active')) updateAnalysis();
            if (document.getElementById('view-company').classList.contains('active')) updateCompanyReport();
        }

        function updateHeaderSubtitle() {
            const range = getDateRangeByScope(currentScope, currentMonth);
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            const sub = document.getElementById('subTitle');
            sub.innerText = `Reporting Period: ${range.start.toLocaleDateString('en-US', options)} - ${range.end.toLocaleDateString('en-US', options)}`;
        }

        function switchTab(tabId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`view-${tabId}`).classList.add('active');
            event.target.classList.add('active');
            if (tabId === 'analysis') updateAnalysis();
            if (tabId === 'company') updateCompanyReport();
        }

        function resetCurrentData() {
            if (confirm(`Delete data for ${branches[currentBranchIndex]} in ${currentMonth}?`)) {
                const days = getDaysInMonth(2026, parseInt(currentMonth.split('-')[1]) - 1);
                for(let i=1; i<=days; i++) {
                    const d = new Date(2026, parseInt(currentMonth.split('-')[1]) - 1, i);
                    const iso = d.toISOString().split('T')[0];
                    if(db[branches[currentBranchIndex]][iso]) delete db[branches[currentBranchIndex]][iso];
                }
                saveData();
                loadFormData();
                updateAnalysis();
            }
        }

        // --- UI Rendering ---
        function renderBranchList() {
            const container = document.getElementById('branchList');
            container.innerHTML = '';
            branches.forEach((b, i) => {
                const div = document.createElement('div');
                div.className = `branch-item ${i === currentBranchIndex ? 'active' : ''}`;
                div.onclick = () => {
                    currentBranchIndex = i;
                    renderBranchList();
                    document.getElementById('pageTitle').innerText = b;
                    loadFormData();
                    updateAnalysis();
                    updateCompanyReport();
                };
                div.innerText = b;
                container.appendChild(div);
            });
            document.getElementById('pageTitle').innerText = branches[currentBranchIndex];
        }

        function renderTableStructure() {
            const thead = document.getElementById('tableHeader');
            const tbody = document.getElementById('tableBody');
            
            let headerHTML = `<th style="min-width:100px; text-align:left; padding-left:20px;">Date</th>`;
            
            // Detect where Aggregators start to draw separator
            let aggregatorStarted = false;

            channels.forEach((ch, index) => {
                const nextIsAggregator = (index + 1 < channels.length && channels[index + 1].type === 'aggregator');
                const isAggregator = ch.type === 'aggregator';

                if (isAggregator && !aggregatorStarted) {
                    aggregatorStarted = true;
                    // Add a visual break before aggregators
                    headerHTML += `<th class="separator-line" style="border-right:3px solid var(--primary-dark); width:2px;"></th>`;
                }

                const headerClass = isAggregator ? 'channel-header aggregator' : 'channel-header';
                const subClass = isAggregator ? 'sub-header aggregator-bg' : 'sub-header';

                headerHTML += `
                    <colgroup span="2">
                        <div class="${headerClass}">${ch.label}</div>
                    </colgroup>
                    <th class="${subClass}">TRN<br><small>ÿπÿØÿØ ÿßŸÑŸÖÿπÿßŸÖŸÑÿßÿ™</small></th>
                    <th class="${subClass}">Avg<br><small>ŸÇŸäŸÖÿ© ÿßŸÑŸÖÿπÿßŸÖŸÑÿ©</small></th>
                `;
            });
            
            headerHTML += `<th class="row-total">Total Sales</th>`;
            thead.innerHTML = headerHTML;

            tbody.innerHTML = '';
            for(let i=1; i<=31; i++) {
                let rowHTML = `<tr id="row-${i}" style="display:none;"><td style="text-align:left; padding-left:20px; font-weight:500;" class="date-cell"></td>`;
                
                let aggregatorStarted = false;
                channels.forEach((ch, index) => {
                    const nextIsAggregator = (index + 1 < channels.length && channels[index + 1].type === 'aggregator');
                    const isAggregator = ch.type === 'aggregator';

                    if (isAggregator && !aggregatorStarted) {
                        aggregatorStarted = true;
                        rowHTML += `<td style="border-right:3px solid var(--primary-dark); background:#fafafa;"></td>`;
                    }

                    rowHTML += `
                        <td><input type="number" step="any" min="0" class="input-trn" data-channel="${ch.id}" placeholder="0"></td>
                        <td><input type="number" step="any" min="0" class="input-avg" data-channel="${ch.id}" placeholder="0.00"></td>
                    `;
                });
                
                rowHTML += `<td class="row-total">0.00</td></tr>`;
                tbody.innerHTML += rowHTML;
            }

            tbody.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', (e) => {
                    calculateRowTotal(e.target.closest('tr'));
                    queueAutoSave();
                });
            });
        }

        function loadFormData() {
            const branchName = branches[currentBranchIndex];
            const branchData = db[branchName] || {};
            const year = parseInt(currentMonth.split('-')[0]);
            const month = parseInt(currentMonth.split('-')[1]) - 1;
            const totalDays = getDaysInMonth(year, month);

            document.getElementById('pageTitle').innerText = branchName;

            for(let i=1; i<=31; i++) document.getElementById(`row-${i}`).style.display = 'none';

            for(let d=1; d<=totalDays; d++) {
                const row = document.getElementById(`row-${d}`);
                row.style.display = '';
                const dateObj = new Date(year, month, d);
                const isoDate = dateObj.toISOString().split('T')[0];
                const dateStr = dateObj.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: '2-digit' });

                row.querySelector('.date-cell').innerText = dateStr;
                row.dataset.date = isoDate;
                
                const dayData = branchData[isoDate] || {};
                row.querySelectorAll('input').forEach(inp => inp.value = '');
                
                Object.keys(dayData).forEach(chId => {
                    const val = dayData[chId];
                    const trnInp = row.querySelector(`.input-trn[data-channel="${chId}"]`);
                    const avgInp = row.querySelector(`.input-avg[data-channel="${chId}"]`);
                    if(trnInp && avgInp) {
                        trnInp.value = val.trn;
                        avgInp.value = val.avg;
                    }
                });
                calculateRowTotal(row);
            }
        }

        function calculateRowTotal(row) {
            let total = 0;
            const branchName = branches[currentBranchIndex];
            const dateKey = row.dataset.date;

            if (!db[branchName][dateKey]) db[branchName][dateKey] = {};

            channels.forEach(ch => {
                const trnInp = row.querySelector(`.input-trn[data-channel="${ch.id}"]`);
                const avgInp = row.querySelector(`.input-avg[data-channel="${ch.id}"]`);
                
                const trn = parseFloat(trnInp.value) || 0;
                const avg = parseFloat(avgInp.value) || 0;
                
                total += (trn * avg);

                if (trn > 0 || avg > 0) db[branchName][dateKey][ch.id] = { trn, avg };
                else delete db[branchName][dateKey][ch.id];
            });
            row.querySelector('.row-total').innerText = total.toFixed(2);
        }

        // --- Analysis Core ---

        function getAggregatedData(branchName, start, end) {
            let res = { totalSales: 0, totalTrn: 0, channelTotals: {}, channelTrns: {}, dailyData: [] };
            channels.forEach(c => {
                res.channelTotals[c.id] = 0;
                res.channelTrns[c.id] = 0;
            });

            const branchData = db[branchName] || {};
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                const iso = d.toISOString().split('T')[0];
                const dayData = branchData[iso] || {};
                let dayTotal = 0;

                channels.forEach(ch => {
                    const val = dayData[ch.id] || { trn: 0, avg: 0 };
                    
                    const trn = Number(val.trn) || 0;
                    const avg = Number(val.avg) || 0;
                    
                    const sale = trn * avg;
                    
                    dayTotal += sale;
                    
                    res.totalSales += sale;
                    res.totalTrn += trn;
                    
                    res.channelTotals[ch.id] += sale;
                    res.channelTrns[ch.id] += trn;
                });
                
                res.dailyData.push({ date: new Date(d), val: dayTotal });
            }
            return res;
        }

        function updateAnalysis() {
            const branchName = branches[currentBranchIndex];
            const { start, end } = getDateRangeByScope(currentScope, currentMonth);
            const data = getAggregatedData(branchName, start, end);

            // Update Global KPIs
            document.getElementById('kpiTotalSales').innerText = data.totalSales.toLocaleString(undefined, {minimumFractionDigits:2});
            document.getElementById('kpiTotalTrn').innerText = data.totalTrn.toLocaleString(undefined, {maximumFractionDigits: 0});
            
            const avgChk = data.totalTrn > 0 ? (data.totalSales / data.totalTrn) : 0;
            document.getElementById('kpiAvgChk').innerText = avgChk.toFixed(2);

            // Company Share
            let companyTotal = 0;
            branches.forEach(b => companyTotal += getAggregatedData(b, start, end).totalSales);
            const share = companyTotal > 0 ? (data.totalSales / companyTotal * 100) : 0;
            document.getElementById('kpiCompanyShare').innerText = share.toFixed(2) + "%";

            // Update Detailed Channel Table (New: % Contribution)
            const tbody = document.getElementById('channelDetailBody');
            tbody.innerHTML = '';
            channels.forEach(ch => {
                const sales = data.channelTotals[ch.id];
                const trns = data.channelTrns[ch.id];
                const avg = trns > 0 ? (sales / trns) : 0;
                const contrib = data.totalSales > 0 ? (sales / data.totalSales * 100) : 0;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="text-align:left; padding-left:20px; font-weight:500;">${ch.label} <small style="color:#888">(${ch.type})</small></td>
                    <td>${sales.toLocaleString(undefined, {minimumFractionDigits:2})}</td>
                    <td>${trns.toLocaleString(undefined, {maximumFractionDigits:0})}</td>
                    <td style="font-weight:bold; color:var(--primary-dark);">${avg.toFixed(2)}</td>
                    <td style="font-weight:bold; color:var(--primary);">${contrib.toFixed(1)}%</td>
                `;
                tbody.appendChild(tr);
            });

            // Draw Charts
            const daysDiff = (end - start) / (1000 * 60 * 60 * 24);
            if (daysDiff > 60) drawTrendChartByMonth(data.dailyData);
            else drawTrendChartDaily(data.dailyData);
            
            drawChannelChart(data.channelTotals);
            
            // New: Avg Check Comparison
            drawAvgCheckComparison(data.channelTotals, data.channelTrns);
        }

        function updateCompanyReport() {
            const tbody = document.getElementById('companyTableBody');
            const tfoot = document.getElementById('companyTableFooter');
            tbody.innerHTML = '';
            tfoot.innerHTML = '';
            
            const { start, end } = getDateRangeByScope(currentScope, currentMonth);
            
            let grandTotal = 0;
            let grandTrn = 0;
            let activeBranches = 0;
            let branchStats = [];

            branches.forEach(b => {
                const d = getAggregatedData(b, start, end);
                grandTotal += d.totalSales;
                grandTrn += d.totalTrn;
                if (d.totalSales > 0) activeBranches++;
                branchStats.push({ name: b, ...d });
            });

            document.getElementById('compTotalSales').innerText = grandTotal.toLocaleString(undefined, {minimumFractionDigits:2});
            document.getElementById('compActiveBranches').innerText = activeBranches;

            branchStats.sort((a,b) => b.totalSales - a.totalSales).forEach(b => {
                const percent = grandTotal > 0 ? (b.totalSales/grandTotal)*100 : 0;
                const avg = b.totalTrn > 0 ? (b.totalSales / b.totalTrn) : 0;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="text-align:left; padding-left:20px;">${b.name}</td>
                    <td>${b.totalSales.toLocaleString(undefined, {minimumFractionDigits:2})}</td>
                    <td>${b.totalTrn.toLocaleString(undefined, {maximumFractionDigits:0})}</td>
                    <td>${avg.toFixed(2)}</td>
                    <td style="font-weight:bold; color:var(--primary);">${percent.toFixed(2)}%</td>
                    <td style="width:150px; padding:5px;">
                         <div style="background:#eee; width:100%; height:8px; border-radius:4px; overflow:hidden;">
                            <div style="background:var(--primary); width:${Math.min(percent,100)}%; height:100%;"></div>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            const grandAvg = grandTrn > 0 ? (grandTotal/grandTrn) : 0;
            
            tfoot.innerHTML = `
                <tr>
                    <td style="text-align:right; padding-right:20px; font-weight:bold;">TOTAL</td>
                    <td style="color:var(--primary);">${grandTotal.toLocaleString(undefined, {minimumFractionDigits:2})}</td>
                    <td>${grandTrn.toLocaleString(undefined, {maximumFractionDigits:0})}</td>
                    <td>${grandAvg.toFixed(2)}</td>
                    <td style="font-weight:bold;">100.00%</td>
                    <td></td>
                </tr>
            `;
        }

        // --- Charting Functions ---

        function drawTrendChartDaily(dataPoints) {
            const svg = document.getElementById('salesChart');
            svg.innerHTML = '';
            const w = 800, h = 300, p = 30;
            const max = Math.max(...dataPoints.map(d => d.val), 10);

            for(let i=0; i<=5; i++) {
                const y = h-p - (i*(h-2*p)/5);
                svg.innerHTML += `<line x1="${p}" y1="${y}" x2="${w-p}" y2="${y}" class="chart-grid" />`;
                svg.innerHTML += `<text x="0" y="${y+3}" class="chart-axis">${Math.round(max/5*i)}</text>`;
            }

            let pts = "";
            dataPoints.forEach((d, i) => {
                const x = p + (i*(w-2*p)/(dataPoints.length-1));
                const y = h-p - (d.val/max*(h-2*p));
                pts += `${x},${y} `;
            });
            svg.innerHTML += `<polyline points="${pts}" class="chart-line" />`;
            
            dataPoints.forEach((d, i) => {
                if(d.val > 0) {
                    const x = p + (i*(w-2*p)/(dataPoints.length-1));
                    const y = h-p - (d.val/max*(h-2*p));
                    svg.innerHTML += `<circle cx="${x}" cy="${y}" r="3" fill="#fff" stroke="var(--primary)" />`;
                }
            });
        }

        function drawTrendChartByMonth(dailyData) {
            const svg = document.getElementById('salesChart');
            svg.innerHTML = '';
            
            const months = [0,0,0,0,0,0,0,0,0,0,0,0];
            dailyData.forEach(d => months[d.date.getMonth()] += d.val);

            const w = 800, h = 300, p = 30;
            const max = Math.max(...months, 10);
            const barW = (w - 2*p) / 12;

            months.forEach((val, i) => {
                const barH = (val/max)*(h-2*p);
                const x = p + (i*barW) + (barW*0.1);
                const y = h-p-barH;
                
                svg.innerHTML += `<rect x="${x}" y="${y}" width="${barW*0.8}" height="${barH}" class="chart-bar">
                    <title>${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][i]}: ${val.toFixed(2)}</title>
                </rect>`;
                svg.innerHTML += `<text x="${x+barW*0.4}" y="${h-p+15}" text-anchor="middle" class="chart-axis">
                    ${["J","F","M","A","M","J","J","A","S","O","N","D"][i]}
                </text>`;
            });
        }

        function drawChannelChart(totals) {
            const svg = document.getElementById('channelChart');
            const leg = document.getElementById('channelLegend');
            svg.innerHTML = ''; leg.innerHTML = '';
            
            const w = 800, h = 300, p = 40;
            const max = Math.max(...Object.values(totals), 10);
            const barW = (w-2*p)/channels.length;
            const colors = ['#e65100', '#ff9800', '#2ecc71', '#3498db', '#9b59b6', '#e74c3c', '#f1c40f', '#34495e'];

            channels.forEach((ch, i) => {
                const val = totals[ch.id];
                const barH = (val/max)*(h-2*p);
                const x = p + (i*barW) + (barW*0.1);
                const y = h-p-barH;
                const col = colors[i%colors.length];

                svg.innerHTML += `<rect x="${x}" y="${y}" width="${barW*0.8}" height="${barH}" class="chart-bar" fill="${col}">
                    <title>${ch.label}: ${val.toFixed(2)}</title>
                </rect>`;
                svg.innerHTML += `<text x="${x+barW*0.4}" y="${h-p+15}" text-anchor="middle" class="chart-axis">${ch.label.split(' ')[0]}</text>`;

                leg.innerHTML += `<div class="legend-item"><div class="color-box" style="background:${col}"></div>${ch.label}</div>`;
            });
        }

        // NEW: Draw Avg Check Comparison Chart
        function drawAvgCheckComparison(channelTotals, channelTrns) {
            const svg = document.getElementById('avgCheckChart');
            svg.innerHTML = '';
            
            const w = 800, h = 300, p = 40;
            
            // Calculate Avg for each channel
            const avgs = [];
            channels.forEach(ch => {
                const sales = channelTotals[ch.id];
                const trn = channelTrns[ch.id];
                const avg = trn > 0 ? (sales / trn) : 0;
                avgs.push({ label: ch.label, val: avg, id: ch.id });
            });

            const max = Math.max(...avgs.map(d => d.val), 10);
            const barW = (w - 2*p) / avgs.length;

            avgs.forEach((item, i) => {
                const barH = (item.val/max)*(h-2*p);
                const x = p + (i*barW) + (barW*0.1);
                const y = h-p-barH;
                
                // Color based on if it's aggregator or in-house
                const col = item.id === 'dine_in' || item.id === 'delivery' ? '#e65100' : '#2ecc71';

                svg.innerHTML += `<rect x="${x}" y="${y}" width="${barW*0.8}" height="${barH}" class="chart-bar" fill="${col}">
                    <title>${item.label}: ${item.val.toFixed(2)}</title>
                </rect>`;
                svg.innerHTML += `<text x="${x+barW*0.4}" y="${y-5}" text-anchor="middle" class="chart-axis" style="font-weight:bold; fill:#555;">${item.val.toFixed(1)}</text>`;
                svg.innerHTML += `<text x="${x+barW*0.4}" y="${h-p+15}" text-anchor="middle" class="chart-axis">${item.label.split(' ')[0]}</text>`;
            });
        }

        let timeout;
        function queueAutoSave() { clearTimeout(timeout); timeout = setTimeout(saveData, 1000); }
        function showToast() {
            const t = document.getElementById('toast');
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }

        updateHeaderSubtitle();

    </script>
</body>
</html>
