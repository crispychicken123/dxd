<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>REST vs POS Reconciliation System</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body{font-family:Segoe UI;background:#f3f4f6;margin:0;padding:20px}
.container{max-width:1400px;margin:auto;background:#fff;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.15);padding:20px}
h1{margin:0 0 15px}
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-bottom:20px}
.kpi{background:#111827;color:#fff;border-radius:10px;padding:15px}
.kpi span{display:block;font-size:24px;font-weight:700}
.controls,.editors{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:15px}
textarea{width:100%;height:160px;font-size:12px;padding:10px}
button,select,input{padding:8px 14px;border-radius:8px;border:1px solid #ccc}
button{background:#2563eb;color:#fff;border:none;cursor:pointer}
table{width:100%;border-collapse:collapse;font-size:12px}
th,td{padding:8px;border-bottom:1px solid #e5e7eb}
th{background:#111827;color:#fff;position:sticky;top:0}
.diff-pos{color:#16a34a;font-weight:bold}
.diff-neg{color:#dc2626;font-weight:bold}
.diff-zero{color:#6b7280}
.bad{background:#fee2e2}
</style>
</head>

<body>
<div class="container">

<h1>ðŸ“Š REST vs POS Reconciliation System</h1>

<!-- KPIs -->
<div class="kpis">
  <div class="kpi">REST Total<span id="kRest">0</span></div>
  <div class="kpi">POS Total<span id="kPos">0</span></div>
  <div class="kpi">Net Difference<span id="kDiff">0</span></div>
  <div class="kpi">Accuracy %<span id="kAcc">100%</span></div>
</div>

<!-- Controls -->
<div class="controls">
  <input id="search" placeholder="Search Item">
  <select id="filter">
    <option value="all">All</option>
    <option value="diff">Only Differences</option>
    <option value="zero">Zero Difference</option>
  </select>
  <button onclick="run()">Run</button>
  <button onclick="exportExcel()">Export Excel</button>
</div>

<!-- DATA MANAGEMENT -->
<div class="editors">
  <div style="flex:1">
    <h4>REST Data (Item | Qty)</h4>
    <textarea id="restData"></textarea>
  </div>
  <div style="flex:1">
    <h4>POS Data (Item | Qty)</h4>
    <textarea id="posData"></textarea>
  </div>
</div>

<div>
<h4>Mapping (raw = standard)</h4>
<textarea id="mapData"></textarea>
<button onclick="saveMapping()">Save Mapping</button>
</div>

<!-- TABLE -->
<table>
<thead>
<tr>
<th>Item</th>
<th>REST</th>
<th>POS</th>
<th>Difference (POS - REST)</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

</div>

<script>
/* ---------- DEFAULT DATA (EDIT ANYTIME) ---------- */

restData.value=`MEGA MEAL MIX|10
Daily Spicy Meal|4808
M.WATER 500ML|525`;

posData.value=`MEGA MEAL MIX|14
Daily Spicy Meal|4808
M.WATER 500ML|525`;

mapData.value=localStorage.getItem("MAP")||`
spicy fries=SPICY - FRIES
not spicy fries=FRENCH FRIES SMALL
extra chesses=EXTRA CHEESE
`;

/* ---------- CORE LOGIC ---------- */

function normalize(t){
 return t.toLowerCase()
 .replace(/[*]/g,"")
 .replace(/-/g," ")
 .replace(/\s+/g," ")
 .trim();
}

function parse(text){
 const o={};
 text.split("\n").forEach(l=>{
  const p=l.split("|");
  if(p.length>=2){
   const k=normalize(p[0]);
   o[k]=(o[k]||0)+(+p[1]||0);
  }
 });
 return o;
}

function getMapping(){
 const m={};
 mapData.value.split("\n").forEach(l=>{
  if(l.includes("=")){
   const p=l.split("=");
   m[normalize(p[0])]=p[1].trim().toUpperCase();
  }
 });
 return m;
}

let RESULT=[];

function run(){
 const map=getMapping();
 const rest=parse(restData.value);
 const pos=parse(posData.value);

 const all=new Set([...Object.keys(rest),...Object.keys(pos)]);
 RESULT=[];

 let tr=0,tp=0,err=0;

 all.forEach(k=>{
  const item=map[k]||k.toUpperCase();
  const r=rest[k]||0;
  const p=pos[k]||0;
  const d=p-r;
  tr+=r; tp+=p;
  if(d!==0) err++;
  RESULT.push({item,r,p,d});
 });

 RESULT.sort((a,b)=>Math.abs(b.d)-Math.abs(a.d));

 kRest.textContent=tr;
 kPos.textContent=tp;
 kDiff.textContent=tp-tr;
 kAcc.textContent=((1-err/RESULT.length)*100).toFixed(1)+"%";

 render();
}

function render(){
 const s=search.value.toUpperCase();
 const f=filter.value;
 tbody.innerHTML="";

 RESULT.forEach(r=>{
  if(s && !r.item.includes(s)) return;
  if(f==="diff" && r.d===0) return;
  if(f==="zero" && r.d!==0) return;

  const tr=document.createElement("tr");
  if(Math.abs(r.d)>20) tr.className="bad";

  tr.innerHTML=`
  <td>${r.item}</td>
  <td>${r.r}</td>
  <td>${r.p}</td>
  <td class="${r.d>0?'diff-pos':r.d<0?'diff-neg':'diff-zero'}">${r.d}</td>`;
  tbody.appendChild(tr);
 });
}

function exportExcel(){
 const ws=XLSX.utils.json_to_sheet(RESULT);
 const wb=XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb,ws,"Reconciliation");
 XLSX.writeFile(wb,"REST_vs_POS.xlsx");
}

function saveMapping(){
 localStorage.setItem("MAP",mapData.value);
 alert("Mapping Saved");
}

search.onkeyup=render;
filter.onchange=render;

run();
</script>

</body>
</html>
